**Post-Query UI Interactions ‚Äì Execution, Preview, and Summary**

---

## 1. Overview

This document defines the user interface and backend behavior after a query is generated by the RAG + LLM system. It captures how users can preview, execute, and summarize OpenObserve queries within the assistant interface.

---

## 2. Inputs Provided by Backend

After user submits a natural language query and RAG/LLM flow completes, the backend returns:

- `index` (stream)
- `openobserve_index` (deployment ‚Üí base URL)
- `sql_query` (OpenObserve-compliant SQL)
- `vrlFunctionQuery` (optional)
- `time_range` (e.g., `last_7d`)
- `confidence_score` (for UI badge)
- `used_derived_fields` (optional)

---

## 3. UI Components

### üîπ 3.1. Query Preview

- Displays generated SQL and VRL block
- Syntax-highlighted, read-only
- Tag badges:
  - Confidence level (`High`, `Medium`, `Low`)
  - Fallback mode used
  - Derived fields (if any)

---

### üîπ 3.2. [Run in OpenObserve] Button

- Constructs a URL to the relevant OpenObserve deployment with:
  - Pre-filled `stream`
  - Query string (`sql_query`)
  - Time filters (`start`, `end` or relative like `now()-7d`)

**Example URL Format:**

```text
https://anivia.logs.prod.walmart.com/web/search?stream=walmart_web_analytics&query=SELECT+...&start=now()-7d
```

- Opens in a new tab
- Assumes user has a session cookie to access logs

---

### üîπ 3.3. [Summarize Result] Button

- Backend behavior:
  1. Executes the SQL query via OpenObserve's `/api/search` endpoint (or via curl if needed)
  2. Samples or aggregates result data
  3. Passes query + results + original question to LLM
  4. Returns a human-readable summary (e.g., "ATC error rate over last 7 days was 4.3% on cart page.")

**Notes:**

- Can show loading state with: *"Fetching and summarizing query results‚Ä¶"*
- For large result sets: *"Summary generated from top 50 rows"*

---

### üîπ 3.4. Feedback + Copy Controls

#### ‚úÖ Copy Button

- One-click copy of `sql_query` to clipboard

#### üëç Thumbs Up

- Sends event payload to backend:

```json
{
  "index": "walmart_web_analytics",
  "user_prompt": "...",
  "given_sql": "...",
  "given_vrl": "...",
  "feedback_type": "negative",
  "corrected_sql_sql_text": "...",
  "corrected_vrl_logic": "...",
  "feedback_comment": "Wrong page context. Should be itemPage not cart."
}
```

- Stored for offline review or retraining

---

## 4. UI Layout Summary

| Component          | Description                                              |
| ------------------ | -------------------------------------------------------- |
| SQL + VRL Preview  | Side-by-side block, collapsible if long                  |
| Run in OpenObserve | Opens search UI with pre-filled query                    |
| Summarize Result   | Fetches + LLM-summarizes response                        |
| Feedback Control   | Thumbs up/down + optional correction form on thumbs down |
| Copy SQL           | One-click copy of generated SQL                          |

---

## 5. Technical Considerations

| Feature               | Detail                                                      |
| --------------------- | ----------------------------------------------------------- |
| OpenObserve Execution | Uses `/api/search` or equivalent internal search API        |
| Auth                  | Passes cookie or service-token if backend executes query    |
| Fallback Path         | Uses backend script with `curl` if API fails or throttled   |
| Rate Limiting         | Cap query response rows for summarization (e.g., 100 rows)  |
| Feedback Pipeline     | Logs both positive and negative interactions for retraining |

---

## 6. Edge Cases

- ‚ö†Ô∏è No session: Disable "Run in OpenObserve" or prompt login
- ‚ö†Ô∏è API failure: Show error toast; log for debugging
- ‚ö†Ô∏è Ambiguous stream: Block execution until `index` is resolved

---

