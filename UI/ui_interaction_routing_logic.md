````markdown
# Index & Environment Selection – UX + Routing Rules

---

## 1. Overview

This document captures how users specify the `index` and `openobserve_index` (environment) to guide accurate query generation and backend RAG routing.

The goal is to ensure:
- Minimal ambiguity during query interpretation
- Precision when similar queries exist across streams or environments
- A natural balance between flexibility and accuracy

---

## 2. Inputs from User

### 🔹 `openobserve_index`
- Represents the environment or URL base (e.g., `anivia`, `prepurchase-fe`)
- Shown as a searchable dropdown
- Optional unless multiple deployments have overlapping indexes

### 🔹 `index` (stream)
- Represents the OpenObserve stream name (e.g., `walmart_web_analytics`, `walmart_app_analytics`)
- Shown as a searchable dropdown, filtered by `openobserve_index` selection
- Must be selected or inferred to ensure schema and dashboard lookups

---

## 3. Interaction Rules

### 🧠 Smart Resolution Logic

| User Input Scenario              | System Behavior                                      |
|----------------------------------|------------------------------------------------------|
| Selects `index` only             | Auto-select matching `openobserve_index` via mapping |
| Selects `openobserve_index` only | Filter `index` dropdown by deployment                |
| Selects both                     | Use both for RAG filtering and API routing           |
| Selects neither                  | Warn user: fallback with reduced accuracy            |

### 🗺️ Prompt Guidance

After stream selection:

> _"To improve query accuracy, mention the index (**`walmart_app_analytics`**) in your question, e.g.:_  
> **‘What’s the error rate for cart page in walmart\_app\_analytics?’”**

If derived fields are detected:

> _"This query uses computed fields from schema. To verify correctness, double-check derived VRL logic in preview."_

---

## 4. Session-Based UI Extensions

### 🧩 History Sidebar
- User can see previous queries with timestamps
- Click to restore full context: prompt, index, result, filters

### ⭐ Favorite Queries
- User can save:
  - `natural_language_prompt`
  - `sql_query`
  - `vrl_function`
  - `index`
  - `openobserve_index`
- Favorites are editable and removable

### 🔁 Frequently Asked Queries
- Generated by usage history
- Shown in slider (top-N, most frequent)
- Clicking auto-fills prompt and reruns agent

### 🕓 Time Range Memory
- Relative or absolute picker saved per favorite or frequent
- Example: “last 1h” or “Aug 1, 9:00 – Aug 2, 13:00”

---

## 5. UX Recommendations

### ✅ Index Selector
- Autocomplete search
- "Explore by index" mode

### ✅ Environment Selector
- Defaults to last-used
- Friendly labels ("Anivia (prod)") + full URL on hover

### ❗ Validation & Alerts
- No `index` → _“Please select a stream (index) for accurate query results.”_
- No fields → _Fallback to global retrieval with degraded schema precision._

---

## 6. Backend Routing Logic

- `index` is primary schema key
- `openobserve_index` adds deployment-level resolution
- Example RAG filter:
```json
{
  "index": "walmart_app_analytics",
  "deployment": "anivia"
}
````

* If no index provided → fallback to default prompt set (global)
* Schema is loaded from local file, validated per deployment

---

## 7. Future Extensions

* Add popularity-based rank hints for index selector
* Allow tagging or starring favorite streams
* Show "Recent AI hits" per index for user trust/training
