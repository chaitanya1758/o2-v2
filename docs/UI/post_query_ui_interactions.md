```markdown
# Post-Query UI Interactions ‚Äì Execution, Preview, and Summary

---

## 1. Overview

This document defines the user interface and backend behavior after a query is generated by the RAG + LLM system. It captures how users can preview, execute, and summarize OpenObserve queries within the assistant interface.

---

## 2. Inputs Provided by Backend

After user submits a natural language query and RAG/LLM flow completes, the backend returns:

- `index` (stream)  
- `openobserve_index` (deployment ‚Üí base URL)  
- `sql_query` (OpenObserve-compliant SQL)  
- `vrlFunctionQuery` (optional)  
- `time_range` (e.g., `last_7d`)  
- `confidence_score` (for UI badge)  
- `used_derived_fields` (optional)  

---

## 3. UI Components

### üîπ 3.1. Query Preview

- Displays generated SQL and VRL block  
- Syntax-highlighted, read-only  
- Tag badges:
  - Confidence level (`High`, `Medium`, `Low`)  
  - Fallback mode used (if any)  
  - Derived fields (if any used)  
  - Trust badge (based on confidence + explain mode)

---

### üîπ 3.2. [Run in OpenObserve] Button

- Constructs a URL to the relevant OpenObserve deployment with:
  - Pre-filled `stream`  
  - Query string (`sql_query`)  
  - Time filters (`start`, `end` or relative like `now()-7d`)  

Example:  
```

[https://anivia.logs.prod.walmart.com/web/search?stream=walmart\_web\_analytics\&query=SELECT+...\&start=now()-7d](https://anivia.logs.prod.walmart.com/web/search?stream=walmart_web_analytics&query=SELECT+...&start=now%28%29-7d)

````

- Opens in a new tab  
- Assumes user has a session cookie to access logs

---

### üîπ 3.3. [Summarize Result] Button

- Backend behavior:
  1. Executes SQL via OpenObserve's `/api/search`  
  2. Samples or aggregates rows (max 100)  
  3. Passes query + results + original prompt to LLM  
  4. Returns human-readable summary  

UI strings:
- Loading: _"Fetching and summarizing query results..."_  
- Large result note: _"Summary generated from top 50 rows"_  
- On fallback: _"LLM failed to summarize ‚Äî showing raw rows instead"_

---

### üîπ 3.4. Feedback + Copy Controls

#### ‚úÖ Copy Button  
- One-click copy of `sql_query`

#### üëç Thumbs Up / üëé Thumbs Down  
- Sends event payload to backend:
```json
{
  "index": "walmart_web_analytics",
  "user_prompt": "...",
  "given_sql": "...",
  "given_vrl": "...",
  "feedback_type": "negative",
  "corrected_sql_sql_text": "...",
  "corrected_vrl_logic": "...",
  "feedback_comment": "Wrong page context. Should be itemPage not cart."
}
````

* Used to retrain prompt flows and improve retrievers
* If schema ambiguity caused issue ‚Üí tag for `schema_hint_required`

---

## 4. UI Layout Summary

| Component          | Description                                          |
| ------------------ | ---------------------------------------------------- |
| SQL + VRL Preview  | Side-by-side block, collapsible if long              |
| Run in OpenObserve | Opens OpenObserve UI with pre-filled query & filters |
| Summarize Result   | Executes + LLM-summarizes query results              |
| Feedback Control   | Thumbs up/down + optional correction form            |
| Copy SQL           | One-click SQL copy                                   |

---

## 5. Technical Considerations

| Feature               | Detail                                                          |
| --------------------- | --------------------------------------------------------------- |
| OpenObserve Execution | Uses `/api/search` or fallback curl                             |
| Auth                  | Uses session token or cookie context                            |
| Row Capping           | Caps sample rows (e.g. 100) before LLM summarization            |
| Feedback Logging      | Positive/negative stored with full prompt + output              |
| VRL Handling          | VRL summary optional; if failed, fallback to SQL-only rendering |

---

## 6. Edge Cases

* ‚ö†Ô∏è No session: disable "Run in OpenObserve" or prompt login
* ‚ö†Ô∏è API failure: toast error and backend log
* ‚ö†Ô∏è Ambiguous index: block summary until index resolved
* ‚ö†Ô∏è LLM fallback mode: raw results shown with banner explanation

